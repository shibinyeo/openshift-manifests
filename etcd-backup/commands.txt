oc new-project ocp-etcd-backup --display-name 'Automated Etcd Backup'

# Add a label to prevent SCC warning
oc label ns ocp-etcd-backup security.openshift.io/scc-podSecurityLabelSync=true

# Single Backup (to make sure this code works)
oc get no -l node-role.kubernetes.io/master --no-headers -o name | head -n 1 | xargs -I {} -- oc debug {} --to-namespace=ocp-etcd-backup -- bash -c 'chroot /host rm -rf /home/core/backup &&
> chroot /host mkdir /home/core/backup &&
> chroot /host sudo -E mount -t nfs <nfs_server>:<nfs_share_dir> /home/core/backup &&
> chroot /host sudo -E /usr/local/bin/cluster-backup.sh /home/core/backup &&
> chroot /host sudo -E find /home/core/backup/ -type f -mmin +"1" -delete'

oc apply -f sa-etcd-bkp.yaml

# Add "privileged" SCC to serviceaccount
oc adm policy add-scc-to-user privileged -z openshift-backup

oc apply -f cluster-role-etcd-bkp.yaml
oc apply -f cluster-role-binding-etcd-bkp.yaml

oc apply -f cronjob-etcd-bkp.yaml

# Create a job from the cronjob to test
oc create job backup --from=cronjob/openshift-backup
watch oc get pods -n ocp-etcd-backup
oc delete job backup   # cleanup

# (on the NFS Server) Check that the backup is generated
ls -l <nfs_share_dir>

